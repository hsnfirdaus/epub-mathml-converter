name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (example: v0.1.0). Leave empty to use v<package.json version>."
        required: false
        type: string

permissions:
  contents: write

jobs:
  metadata:
    name: Resolve release metadata
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.meta.outputs.release_tag }}
      package_version: ${{ steps.meta.outputs.package_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve tag and version
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          PKG_VERSION="$(node -p "require('./package.json').version")"

          if [[ "${GITHUB_EVENT_NAME}" == "push" ]]; then
            RELEASE_TAG="${GITHUB_REF_NAME}"
          else
            INPUT_TAG="${{ github.event.inputs.tag }}"
            if [[ -n "${INPUT_TAG}" ]]; then
              RELEASE_TAG="${INPUT_TAG}"
            else
              RELEASE_TAG="v${PKG_VERSION}"
            fi
          fi

          if [[ ! "${RELEASE_TAG}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+([-.].+)?$ ]]; then
            echo "Release tag must look like vX.Y.Z (or vX.Y.Z-suffix). Got: ${RELEASE_TAG}" >&2
            exit 1
          fi

          EXPECTED_TAG="v${PKG_VERSION}"
          if [[ "${RELEASE_TAG}" != "${EXPECTED_TAG}" ]]; then
            echo "Tag/version mismatch: package.json=${PKG_VERSION}, tag=${RELEASE_TAG}" >&2
            echo "Use tag ${EXPECTED_TAG} or update package.json version first." >&2
            exit 1
          fi

          echo "release_tag=${RELEASE_TAG}" >> "$GITHUB_OUTPUT"
          echo "package_version=${PKG_VERSION}" >> "$GITHUB_OUTPUT"

  build:
    name: Build binaries
    runs-on: ubuntu-latest
    needs: metadata
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux-x64
            bun_target: bun-linux-x64
            binary_name: epub-mathml-converter-linux-x64
          - platform: windows-x64
            bun_target: bun-windows-x64
            binary_name: epub-mathml-converter-windows-x64.exe
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build ${{ matrix.platform }} binary
        run: |
          mkdir -p dist
          bun build ./src/index.ts \
            --compile \
            --target ${{ matrix.bun_target }} \
            --outfile dist/${{ matrix.binary_name }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.binary_name }}
          path: dist/${{ matrix.binary_name }}
          if-no-files-found: error

  release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs:
      - metadata
      - build
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.metadata.outputs.release_tag }}
          name: ${{ needs.metadata.outputs.release_tag }}
          generate_release_notes: true
          append_body: true
          body: |
            Project: https://github.com/hsnfirdaus/epub-mathml-converter
            Usage guide: https://github.com/hsnfirdaus/epub-mathml-converter#quick-start-usage-first

            Downloads in this release:
            - `epub-mathml-converter-linux-x64`
            - `epub-mathml-converter-windows-x64.exe`
          fail_on_unmatched_files: true
          files: |
            release-assets/*
